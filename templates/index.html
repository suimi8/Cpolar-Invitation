<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cpolar æ‰¹é‡æ³¨å†Œå·¥å…· - æç®€ä¸»ä¹‰è®¾è®¡</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Noto+Sans+SC:wght@300;400;700&display=swap"
        rel="stylesheet">
    <!-- Three.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <style>
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header-text {
            text-align: left;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .nav-btn,
        .logout-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .nav-btn {
            background: var(--bg-color);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .nav-btn:hover {
            background: var(--primary);
            color: white;
        }

        .logout-btn {
            color: var(--text-dim);
        }

        .logout-btn:hover {
            color: var(--error);
        }

        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header class="header-content">
            <div class="header-text">
                <h1>Cpolar <span class="accent">Batch</span></h1>
                <p class="subtitle">é«˜æ•ˆã€ç¨³å®šçš„è‡ªåŠ¨åŒ–æ‰¹é‡æ³¨å†Œå¥—ä»¶</p>
            </div>
            <div class="header-actions">
                {% if is_admin %}
                <a href="/admin" class="nav-btn">åå°ç®¡ç†</a>
                {% endif %}
                <a href="/logout" class="logout-btn">é€€å‡ºç™»å½•</a>
            </div>
        </header>

        <main class="glass-card">
            <div class="input-group">
                <div class="field">
                    <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                        <label for="inviteCode">é‚€è¯·ç </label>
                        <a href="javascript:void(0)" id="openFetchModal"
                            style="font-size: 0.8rem; color: var(--primary); text-decoration: none; margin-bottom: 5px;">
                            ä¸çŸ¥é“åœ¨å“ªï¼Ÿç‚¹æˆ‘ç™»å½•ä¸€é”®è·å–ï¼
                        </a>
                    </div>
                    <input type="text" id="inviteCode" placeholder="è¾“å…¥é‚€è¯·ç ..." value="">
                </div>

                <div class="field">
                    <label for="cdkey">éªŒè¯å¡å¯†</label>
                    <input type="text" id="cdkey" placeholder="è¯·è¾“å…¥æ‚¨çš„æˆæƒå¡å¯†..." autocomplete="off">
                </div>

                <button id="startBtn" class="primary-btn">éªŒè¯å¡å¯†å¹¶å¼€å§‹æ³¨å†Œ</button>
            </div>

            <!-- Cpolar Login Modal -->
            <div id="fetchModal" class="modal-overlay" style="display: none;">
                <div class="glass-card modal-card" style="max-width: 450px; width: 90%; padding: 2rem;">
                    <h3>è·å– Cpolar æ¨å¹¿ç </h3>
                    <p style="font-size: 0.85rem; color: var(--text-dim); margin-bottom: 1.5rem;">
                        è¯·è¾“å…¥ Cpolar å®˜ç½‘è´¦å·å¯†ç ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ç™»å½•å¹¶ä¸ºæ‚¨æå–é‚€è¯·ç å’Œå¥—é¤ä¿¡æ¯ã€‚
                    </p>
                    <div class="field" style="margin-bottom: 1rem;">
                        <label>Cpolar è´¦å· (é‚®ç®±)</label>
                        <input type="text" id="cpolarEmail" placeholder="example@qq.com">
                    </div>
                    <div class="field" style="margin-bottom: 1.5rem;">
                        <label>Cpolar å¯†ç </label>
                        <input type="password" id="cpolarPassword" placeholder="******">
                    </div>

                    <!-- å¥—é¤ä¿¡æ¯å±•ç¤ºåŒº (åˆå§‹éšè—) -->
                    <div id="planInfoBox"
                        style="display: none; margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 10px; border: 1px solid #86efac;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem;">
                            <span style="font-size: 1.2rem;">ğŸ‰</span>
                            <span style="font-weight: 600; color: #166534;">å¥—é¤ä¿¡æ¯</span>
                        </div>
                        <div
                            style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.8rem; text-align: center;">
                            <div>
                                <div id="planName" style="font-size: 1.3rem; font-weight: 700; color: #15803d;">-</div>
                                <div style="font-size: 0.75rem; color: #166534;">å½“å‰å¥—é¤</div>
                            </div>
                            <div>
                                <div id="planStart" style="font-size: 0.85rem; font-weight: 500; color: #166534;">-
                                </div>
                                <div style="font-size: 0.75rem; color: #166534;">å¼€å§‹æ—¶é—´</div>
                            </div>
                            <div>
                                <div id="planEnd" style="font-size: 0.85rem; font-weight: 500; color: #166534;">-</div>
                                <div style="font-size: 0.75rem; color: #166534;">ç»“æŸæ—¶é—´</div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button id="closeFetchModal" class="secondary-btn" style="width: auto; flex: 1;">å–æ¶ˆ</button>
                        <button id="doFetchCode" class="primary-btn" style="width: auto; flex: 2;">ä¸€é”®è·å–</button>
                    </div>
                </div>
            </div>

            <div class="status-panel" id="statusPanel" style="display: none; margin-top: 2rem;">
                <div class="progress-container">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem;">
                        <span id="progressText">å‡†å¤‡ä¸­...</span>
                        <span id="percentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="stats-row" style="margin-top: 1.5rem; grid-template-columns: 1fr 1fr;">
                    <div class="stat-card">
                        <div class="number" id="completedNum">0</div>
                        <div class="label">å·²å®Œæˆ</div>
                    </div>
                    <div class="stat-card">
                        <div class="number success-text" id="successNum" style="color: var(--success);">0</div>
                        <div class="label">æˆåŠŸ</div>
                    </div>
                </div>
            </div>

            <div class="log-container" id="logContainer" style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; align-items: center;">
                    <h3 style="font-size: 1.1rem;">å®æ—¶æ—¥å¿—</h3>
                    <button id="clearLogs"
                        style="background: none; border: none; color: var(--text-dim); cursor: pointer;">æ¸…ç©º</button>
                </div>
                <div class="log-box" id="logContent">
                    <div class="log-entry system">ç­‰å¾…ä»»åŠ¡å¼€å§‹...</div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 Cpolar Automation Suite</p>
        </footer>
    </div>

    <div id="instructionsSection" style="margin-top: 2rem; display: none;">
        <h2 style="color: white; margin-bottom: 1rem; font-weight: 300;">ä½¿ç”¨è¯´æ˜</h2>
        <div id="instructionList" style="display: grid; gap: 1.5rem;">
            <!-- Dynamic Content -->
        </div>
    </div>

    <script src="/static/js/main.js"></script>
    <script src="/static/js/background.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('instructionList');
            const section = document.getElementById('instructionsSection');

            try {
                const res = await fetch('/api/instructions');
                const data = await res.json();

                if (data.instructions && data.instructions.length > 0) {
                    section.style.display = 'block';

                    data.instructions.forEach(async (inst) => {
                        // Creating card for each instruction
                        const card = document.createElement('div');
                        card.className = 'glass-card';
                        card.style.padding = '1.5rem';
                        card.style.cursor = 'pointer';
                        card.onclick = () => toggleInstruction(inst.id, card);

                        card.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; font-size: 1.2rem;">${inst.title}</h3>
                                <div style="font-size: 0.85rem; color: var(--text-dim);">
                                    ${inst.author || 'Admin'} â€¢ ${inst.publish_date}
                                </div>
                            </div>
                            <div id="content-${inst.id}" style="display: none; margin-top: 1.5rem; border-top: 1px solid rgba(0,0,0,0.05); padding-top: 1rem; line-height: 1.6;">
                                Loading...
                            </div>
                        `;
                        container.appendChild(card);
                    });
                }
            } catch (e) {
                console.error("Failed to load instructions", e);
            }
        });

        async function toggleInstruction(id, card) {
            const contentDiv = document.getElementById(`content-${id}`);
            if (contentDiv.style.display === 'none') {
                contentDiv.style.display = 'block';
                // Load detail if not loaded
                if (contentDiv.innerText === 'Loading...') {
                    try {
                        const res = await fetch(`/api/instructions/${id}`);
                        const data = await res.json();
                        if (data.content) {
                            contentDiv.innerHTML = renderContent(data.content);
                        }
                    } catch (e) {
                        contentDiv.innerText = 'åŠ è½½å¤±è´¥';
                    }
                }
            } else {
                contentDiv.style.display = 'none';
            }
        }

        function renderContent(text) {
            if (!text) return '';
            let html = text;

            // Handle Image Placeholders: [IMAGE: url]
            const imgRegex = /\[IMAGE:\s*(.*?)\]/g;
            html = html.replace(imgRegex, (match, url) => {
                return `<div style="text-align: center; margin: 1.5rem 0;">
                            <img src="${url.trim()}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-block;">
                        </div>`;
            });

            // Convert newlines to <br>
            html = html.replace(/\n/g, '<br>');
            return html;
        }
    </script>
</body>

</html>