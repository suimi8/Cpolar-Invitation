<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后台管理 - Cpolar 批量注册工具</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=Noto+Sans+SC:wght@300;400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header-left h1 {
            margin: 0;
            font-size: 2rem;
        }

        .header-right a {
            margin-left: 1rem;
            text-decoration: none;
            color: var(--text-dim);
        }

        .header-right a:hover {
            color: var(--primary);
        }

        /* Tabs Styling */
        .tab-nav {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 0.5rem;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 0.8rem 1.2rem;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-dim);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
            width: 100%;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-header h2 {
            font-size: 1.4rem;
            color: var(--text-main);
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: pointer;
            border: none;
            transition: opacity 0.2s;
        }

        .btn-small:hover {
            opacity: 0.8;
        }

        .btn-copy {
            background: #e0f2fe;
            color: #0284c7;
        }

        .btn-danger {
            background: #fee2e2;
            color: #ef4444;
        }

        .btn-warning {
            background: #fef3c7;
            color: #d97706;
        }

        .sub-header {
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
            padding-left: 0.8rem;
            font-weight: 700;
            color: var(--text-main);
        }

        /* Responsive Table adjustments */
        .table-container {
            width: 100%;
            overflow-x: auto;
            background: white;
            border-radius: 12px;
            border: 1px solid #f1f5f9;
        }

        .cdkey-table {
            min-width: 900px;
        }
    </style>
</head>

<body>
    <div class="container container-wide">
        <header class="page-header">
            <div class="header-left">
                <h1>Cpolar <span class="accent">Admin</span></h1>
                <p class="subtitle">系统管理与安全监控中心</p>
            </div>
            <div class="header-right">
                <a href="/">← 返回首页</a>
                <a href="/logout">退出登录</a>
            </div>
        </header>

        <nav class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('tab-cdkeys')">卡密管理</button>
            <button class="tab-btn" onclick="switchTab('tab-users')">邀请统计</button>
            <button class="tab-btn" onclick="switchTab('tab-security')">安全中心</button>
            <button class="tab-btn" onclick="switchTab('tab-instructions')">使用说明</button>
        </nav>

        <main class="glass-card" style="padding: 2rem; min-height: 500px;">
            <!-- Tab 1: 卡密管理 -->
            <div id="tab-cdkeys" class="tab-content active">
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="number" id="statTotal">0</div>
                        <div class="label">总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="statUnused" style="color: var(--success);">0</div>
                        <div class="label">未使用</div>
                    </div>
                    <div class="stat-card">
                        <div class="number" id="statUsed" style="color: var(--error);">0</div>
                        <div class="label">已使用</div>
                    </div>
                </div>

                <div class="section-header">
                    <h2>卡密控制</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="primary-btn" onclick="exportCdkeys()"
                            style="width: auto; background-color: var(--success);">导出TXT</button>
                        <button class="primary-btn" onclick="cleanupCdkeys()"
                            style="width: auto; background-color: #f97316;">清理已用</button>
                        <button class="primary-btn" onclick="clearAllCdkeys()"
                            style="width: auto; background-color: var(--error);">一键清空</button>
                    </div>
                </div>

                <div class="cdkey-controls"
                    style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.2rem; margin-bottom: 2rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label>生成数量:</label>
                            <input type="number" id="generateCount" value="10" min="1" max="100" style="width: 80px;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label>卡密长度:</label>
                            <input type="number" id="generateLength" value="16" min="8" max="32" style="width: 80px;">
                        </div>
                        <button class="primary-btn" onclick="generateCdkeys()"
                            style="width: auto; padding-left: 2rem; padding-right: 2rem;">生成新卡密</button>
                        <button class="secondary-btn" onclick="loadCdkeys()" style="width: auto;">刷新列表</button>
                    </div>
                </div>

                <div class="sub-header">未使用卡密 (Unused)</div>
                <div class="table-container">
                    <div id="cdkeyListUnused">
                        <div style="padding: 2rem; text-align: center; color: var(--text-dim);">加载中...</div>
                    </div>
                </div>

                <div class="sub-header">已使用卡密 (Used)</div>
                <div class="table-container">
                    <div id="cdkeyListUsed">
                        <div style="padding: 2rem; text-align: center; color: var(--text-dim);">加载中...</div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: 邀请统计 -->
            <div id="tab-users" class="tab-content">
                <div class="stats-row" style="margin-bottom: 2rem;">
                    <div class="stat-card" style="flex: 1;">
                        <div class="number" id="statTotalInvites" style="color: var(--primary);">0</div>
                        <div class="label">总注册人数</div>
                    </div>
                </div>
                <div class="section-header">
                    <h2>邀请码完成统计</h2>
                    <button class="secondary-btn" onclick="loadAccounts()" style="width: auto;">刷新统计</button>
                </div>
                <div class="table-container">
                    <div id="accountList">
                        <div style="padding: 3rem; text-align: center; color: var(--text-dim);">正在加载统计数据...</div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: 安全中心 -->
            <div id="tab-security" class="tab-content">
                <div class="section-header">
                    <h2>IP 访问控制 / 封禁管理</h2>
                    <button class="secondary-btn" onclick="loadBans()" style="width: auto;">刷新封禁列表</button>
                </div>

                <div
                    style="background: #fffafa; border: 1px solid #fee2e2; border-radius: 12px; padding: 1.2rem; margin-bottom: 2rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label>手动封禁 IP:</label>
                            <input type="text" id="banIpInput" placeholder="输入 IP 地址..." style="width: 200px;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <label>原因:</label>
                            <input type="text" id="banReasonInput" value="管理员手动封禁" style="width: 200px;">
                        </div>
                        <button class="primary-btn" onclick="manualBan()"
                            style="width: auto; background-color: var(--error);">封禁 IP</button>
                    </div>
                </div>

                <div class="sub-header">当前生效的封禁列表</div>
                <div class="table-container">
                    <div id="banList">
                        <div style="padding: 3rem; text-align: center; color: var(--text-dim);">正在加载封禁记录...</div>
                    </div>
                </div>
            </div>

            <!-- Tab 4: 使用说明管理 -->
            <div id="tab-instructions" class="tab-content">
                <div class="section-header">
                    <h2>使用说明管理</h2>
                    <button class="primary-btn" onclick="showInstructionForm()" style="width: auto;">+ 发布新说明</button>
                </div>

                <!-- Form Section (Hidden by default) -->
                <div id="instructionForm"
                    style="display: none; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                    <h3 id="formTitle" style="margin-top: 0; margin-bottom: 1rem;">发布说明</h3>
                    <input type="hidden" id="instId">

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">标题</label>
                            <input type="text" id="instTitle" class="form-input"
                                style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #cbd5e1;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">作者</label>
                            <input type="text" id="instAuthor" class="form-input" value="Admin"
                                style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #cbd5e1;">
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">发布日期</label>
                        <input type="date" id="instDate" class="form-input"
                            style="width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #cbd5e1;">
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <label style="font-size: 0.9rem;">正文内容 (支持占位符 [IMAGE: url])</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn-small success-btn" id="previewBtn" onclick="togglePreview()"
                                    style="background: #e0e7ff; color: #4338ca;">实时预览</button>
                                <button class="btn-small btn-copy" onclick="insertWebImage()">插入网络图片</button>
                                <button class="btn-small btn-copy"
                                    onclick="document.getElementById('imgUpload').click()">上传图片</button>
                            </div>
                            <input type="file" id="imgUpload" hidden accept="image/*" onchange="uploadImage(this)">
                        </div>

                        <!-- Editor & Preview Container -->
                        <div style="position: relative;">
                            <textarea id="instContent" rows="12" placeholder="输入说明内容...&#10;图片将独自占行显示。"
                                style="width: 100%; padding: 0.8rem; border-radius: 6px; border: 1px solid #cbd5e1; font-family: monospace; resize: vertical; line-height: 1.6;"></textarea>

                            <div id="previewBox"
                                style="display: none; width: 100%; min-height: 300px; padding: 1.5rem; border: 1px solid #cbd5e1; border-radius: 6px; background: white; white-space: pre-wrap; word-break: break-all;">
                                <!-- Preview content renders here -->
                            </div>
                        </div>

                        <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 0.3rem;">
                            提示: 图片会以 [IMAGE: url] 格式插入，预览模式下可查看实际效果。
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button class="secondary-btn" onclick="hideInstructionForm()" style="width: auto;">取消</button>
                        <button class="primary-btn" onclick="saveInstruction()" style="width: auto;">保存发布</button>
                    </div>
                </div>

                <div class="table-container">
                    <div id="instructionList">
                        <div style="padding: 3rem; text-align: center; color: var(--text-dim);">加载中...</div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>&copy; 2025 Cpolar Automation Suite</p>
        </footer>
    </div>

    <div class="toast" id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="/static/js/background.js"></script>
    <script>
        // Tab Switcher
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');

            // Refresh data based on tab
            if (tabId === 'tab-cdkeys') loadCdkeys();
            if (tabId === 'tab-users') loadAccounts();
            if (tabId === 'tab-security') loadBans();
            if (tabId === 'tab-instructions') loadInstructions();
        }

        // Toast helper
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = isError ? 'var(--error)' : 'var(--success)';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('已复制到剪贴板');
            });
        }

        // --- CDKey Management ---
        async function loadCdkeys() {
            try {
                const response = await fetch('/api/cdkeys');
                const data = await response.json();

                document.getElementById('statTotal').textContent = data.stats.total;
                document.getElementById('statUnused').textContent = data.stats.unused;
                document.getElementById('statUsed').textContent = data.stats.used;

                const unusedList = data.cdkeys.filter(k => !k.is_used);
                const usedList = data.cdkeys.filter(k => k.is_used);

                renderCdkeyTable('cdkeyListUnused', unusedList);
                renderCdkeyTable('cdkeyListUsed', usedList);

            } catch (err) {
                console.error(err);
                showToast('加载卡密失败', true);
            }
        }

        function renderCdkeyTable(elementId, items) {
            const container = document.getElementById(elementId);
            if (items.length === 0) {
                container.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-dim);">暂无数据</div>';
                return;
            }

            let html = `
                <table class="cdkey-table">
                    <thead>
                        <tr>
                            <th>卡密</th>
                            <th>状态</th>
                            <th>使用 IP / 时间</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            items.forEach(item => {
                const statusHtml = item.is_used
                    ? `<span class="status-used">已使用</span>`
                    : `<span class="status-unused">未使用</span>`;

                const usageInfo = item.is_used
                    ? `<div style="font-size: 0.85rem;">IP: ${item.used_by_ip || '-'}<br>T: ${item.used_at || '-'}</div>`
                    : '-';

                html += `
                    <tr>
                        <td><span class="cdkey-code" onclick="copyToClipboard('${item.code}')" style="cursor:pointer">${item.code}</span></td>
                        <td>${statusHtml}</td>
                        <td>${usageInfo}</td>
                        <td style="font-size: 0.85rem; color: var(--text-dim)">${item.created_at}</td>
                        <td>
                            <button class="btn-small btn-copy" onclick="copyToClipboard('${item.code}')">复制</button>
                            <button class="btn-small btn-danger" onclick="deleteCdkey(${item.id})">删除</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function generateCdkeys() {
            const count = document.getElementById('generateCount').value;
            const length = document.getElementById('generateLength').value;
            try {
                const res = await fetch('/api/cdkeys/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ count, length })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(`成功生成 ${data.count} 个卡密`);
                    loadCdkeys();
                }
            } catch (e) { showToast('生成失败', true); }
        }

        async function exportCdkeys() { window.open('/api/cdkeys/export', '_blank'); }

        async function cleanupCdkeys() {
            if (!confirm('确定清理所有已使用的卡密吗？')) return;
            try {
                const res = await fetch('/api/cdkeys/cleanup', { method: 'POST' });
                const data = await res.json();
                if (data.success) { showToast(`清理完成，删除了 ${data.count} 条记录`); loadCdkeys(); }
            } catch (e) { showToast('清理失败', true); }
        }

        async function clearAllCdkeys() {
            if (!confirm('【警告】确定清空所有卡密吗？未使用卡密也将被永久删除！')) return;
            try {
                const res = await fetch('/api/cdkeys/cleanup_all', { method: 'POST' });
                const data = await res.json();
                if (data.success) { showToast(`已彻底清空所有卡密`); loadCdkeys(); }
            } catch (e) { showToast('清空失败', true); }
        }

        async function deleteCdkey(id) {
            if (!confirm('确定删除该卡密？')) return;
            try {
                const res = await fetch(`/api/cdkeys/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) { showToast('删除成功'); loadCdkeys(); }
            } catch (e) { showToast('删除失败', true); }
        }

        // --- Account Management ---
        async function loadAccounts() {
            try {
                const res = await fetch('/api/accounts');
                const data = await res.json();
                const container = document.getElementById('accountList');

                // 更新总数统计
                document.getElementById('statTotalInvites').textContent = data.total || 0;

                if (!data.invite_stats || data.invite_stats.length === 0) {
                    container.innerHTML = '<div style="padding: 3rem; text-align: center; color: var(--text-dim);">暂无邀请记录</div>';
                    return;
                }

                let html = `
                    <table class="cdkey-table">
                        <thead>
                            <tr>
                                <th>邀请码</th>
                                <th>邀请人数</th>
                                <th>占比</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // 按邀请人数排序（从多到少）
                const sortedStats = data.invite_stats.sort((a, b) => b.count - a.count);
                const total = data.total || 1;

                sortedStats.forEach(item => {
                    const percent = ((item.count / total) * 100).toFixed(1);
                    html += `
                        <tr>
                            <td><span class="cdkey-code" style="background:#e0f2fe; color:#0284c7;" onclick="copyToClipboard('${item.invite_code}')">${item.invite_code}</span></td>
                            <td style="font-weight: 700; font-size: 1.1rem; color: var(--success);">${item.count} 人</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="width: 100px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div style="width: ${percent}%; height: 100%; background: var(--primary);"></div>
                                    </div>
                                    <span style="font-size: 0.85rem; color: var(--text-dim);">${percent}%</span>
                                </div>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) { showToast('统计加载失败', true); }
        }

        // --- Security / Bans ---
        async function loadBans() {
            try {
                const res = await fetch('/api/bans');
                const data = await res.json();
                const container = document.getElementById('banList');

                if (!data.bans || data.bans.length === 0) {
                    container.innerHTML = '<div style="padding: 3rem; text-align: center; color: var(--text-dim);">当前没有封禁的 IP</div>';
                    return;
                }

                let html = `
                    <table class="cdkey-table">
                        <thead>
                            <tr>
                                <th>封禁 IP</th>
                                <th>原因</th>
                                <th>封禁时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.bans.forEach(b => {
                    html += `
                        <tr>
                            <td style="font-weight: 700; color: var(--error)">${b.ip}</td>
                            <td>${b.reason}</td>
                            <td style="font-size: 0.85rem">${b.banned_at}</td>
                            <td>
                                <button class="btn-small btn-warning" onclick="unbanIp('${b.ip}')">解除封禁</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) { showToast('封禁列表加载失败', true); }
        }

        async function manualBan() {
            const ip = document.getElementById('banIpInput').value;
            const reason = document.getElementById('banReasonInput').value;
            if (!ip) return showToast('请输入 IP 地址', true);

            try {
                const res = await fetch('/api/bans/ban', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip, reason })
                });
                const data = await res.json();
                if (data.success) { showToast(`IP ${ip} 已封禁`); loadBans(); }
            } catch (e) { showToast('封禁操作失败', true); }
        }

        async function unbanIp(ip) {
            try {
                const res = await fetch('/api/bans/unban', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip })
                });
                const data = await res.json();
                if (data.success) { showToast('已解除封禁'); loadBans(); }
            } catch (e) { showToast('解除封禁失败', true); }
        }

        // --- Instruction Management ---
        let currentInstId = null;

        async function loadInstructions() {
            try {
                const res = await fetch('/api/admin/instructions');
                const data = await res.json();
                const container = document.getElementById('instructionList');

                if (!data.instructions || data.instructions.length === 0) {
                    container.innerHTML = '<div style="padding: 3rem; text-align: center; color: var(--text-dim);">暂无已发布说明</div>';
                    return;
                }

                let html = `
                    <table class="cdkey-table">
                        <thead>
                            <tr>
                                <th>标题</th>
                                <th>作者</th>
                                <th>发布日期</th>
                                <th>创建时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.instructions.forEach(inst => {
                    html += `
                        <tr>
                            <td style="font-weight: 600;">${inst.title}</td>
                            <td>${inst.author || '-'}</td>
                            <td>${inst.publish_date || '-'}</td>
                            <td style="font-size: 0.85rem; color: var(--text-dim);">${inst.created_at}</td>
                            <td>
                                <button class="btn-small btn-copy" onclick="editInstruction(${inst.id})">编辑</button>
                                <button class="btn-small btn-danger" onclick="deleteInstruction(${inst.id})">删除</button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (e) { showToast('加载说明列表失败', true); }
        }

        function showInstructionForm() {
            document.getElementById('instructionForm').style.display = 'block';
            document.getElementById('formTitle').textContent = '发布新说明';
            document.getElementById('instId').value = '';
            document.getElementById('instTitle').value = '';
            document.getElementById('instAuthor').value = 'Admin';
            document.getElementById('instDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('instContent').value = '';
            currentInstId = null;
        }

        function hideInstructionForm() {
            document.getElementById('instructionForm').style.display = 'none';
        }

        async function saveInstruction() {
            const title = document.getElementById('instTitle').value;
            const author = document.getElementById('instAuthor').value;
            const publish_date = document.getElementById('instDate').value;
            const content = document.getElementById('instContent').value;

            if (!title || !content) return showToast('标题和内容不能为空', true);

            const method = currentInstId ? 'PUT' : 'POST';
            const url = currentInstId ? `/api/admin/instructions/${currentInstId}` : '/api/admin/instructions';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, author, publish_date, content })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(currentInstId ? '更新成功' : '发布成功');
                    hideInstructionForm();
                    loadInstructions();
                } else {
                    showToast(data.message || '操作失败', true);
                }
            } catch (e) { showToast('保存失败', true); }
        }

        async function deleteInstruction(id) {
            if (!confirm('确定删除此说明文档？')) return;
            try {
                const res = await fetch(`/api/admin/instructions/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) { showToast('删除成功'); loadInstructions(); }
            } catch (e) { showToast('删除失败', true); }
        }

        async function editInstruction(id) {
            try {
                const res = await fetch(`/api/instructions/${id}`);
                const data = await res.json();

                showInstructionForm();
                document.getElementById('formTitle').textContent = '编辑说明';
                document.getElementById('instId').value = data.id;
                document.getElementById('instTitle').value = data.title;
                document.getElementById('instAuthor').value = data.author;
                document.getElementById('instDate').value = data.publish_date;
                document.getElementById('instContent').value = data.content;
                currentInstId = data.id;

                // Scroll to form
                document.getElementById('instructionForm').scrollIntoView({ behavior: 'smooth' });
            } catch (e) { showToast('加载详情失败', true); }
        }

        // --- Content Rendering Logic ---
        function renderContent(text) {
            if (!text) return '';

            // Basic HTML escaping if we want to treat it as mixed content, but user wants "placeholders"
            // For now, we trust the input somewhat as it is admin side, but let's be careful.
            let html = text;

            // Handle Image Placeholders: [IMAGE: url]
            // Format: block div
            const imgRegex = /\[IMAGE:\s*(.*?)\]/g;
            html = html.replace(imgRegex, (match, url) => {
                return `<div style="text-align: center; margin: 1.5rem 0;">
                            <img src="${url.trim()}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: inline-block;">
                        </div>`;
            });

            // Convert newlines to <br> for text parts
            // This is a simple heuristic. Ideally we'd parse line by line.
            html = html.replace(/\n/g, '<br>');

            return html;
        }

        async function uploadImage(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.location) {
                    insertPlaceholder(data.location.trim());
                    showToast('图片上传成功');
                } else {
                    showToast(data.message || '上传失败', true);
                }
            } catch (e) { showToast('上传出错', true); }
            input.value = ''; // Reset
        }

        function insertWebImage() {
            const url = prompt("请输入网络图片地址 (URL):");
            if (url) {
                insertPlaceholder(url.trim());
            }
        }

        function insertPlaceholder(url) {
            const textarea = document.getElementById('instContent');
            // Ensure strictly separate lines
            const placeholder = `\n[IMAGE: ${url}]\n`;

            const startPos = textarea.selectionStart;
            const endPos = textarea.selectionEnd;

            // Insert
            textarea.value = textarea.value.substring(0, startPos) + placeholder + textarea.value.substring(endPos, textarea.value.length);

            // Update preview if active
            const previewBox = document.getElementById('previewBox');
            if (previewBox && previewBox.style.display !== 'none') {
                previewBox.innerHTML = renderContent(textarea.value);
            }
        }

        function togglePreview() {
            const editor = document.getElementById('instContent');
            const preview = document.getElementById('previewBox');
            const btn = document.getElementById('previewBtn');

            if (preview.style.display === 'none') {
                // Show Preview
                preview.innerHTML = renderContent(editor.value);
                preview.style.display = 'block';
                editor.style.display = 'none';
                btn.textContent = '返回编辑';
                btn.style.background = '#f1f5f9';
                btn.style.color = '#333';
            } else {
                // Show Editor
                preview.style.display = 'none';
                editor.style.display = 'block';
                btn.textContent = '实时预览';
                btn.style.background = ''; // reset to class default
                btn.style.color = '';
            }
        }

        // Init load
        document.addEventListener('DOMContentLoaded', () => {
            loadCdkeys();
        });
    </script>
</body>

</html>